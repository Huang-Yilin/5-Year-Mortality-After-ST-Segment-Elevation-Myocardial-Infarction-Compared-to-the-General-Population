---
title: "ana_stemi"
author: "hyl"
date: "2024-09-29"
output: html_document
---
#0.1公式及包准备
```{r setup, include=FALSE}
install.packages("pacman")
library(pacman)
p_load(haven,mice,survey,dplyr,tibble,knitr,tidyverse,tidyfst,lattice,tableone,writexl,table1,readxl,survminer,foreign,car,sjmisc,nricens,openxlsx,Hmisc,ggtext,patchwork,ggplotify,cowplot,labelled,WeightIt,forestplot,gridExtra,cobalt,PSweight,lme4,geepack,MatchIt,flexsurv,boot,rstpm2,rms,data.table)


my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=3), c("",
        "Mean (SD)"=sprintf("%s &plusmn; %s", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.1f %%)", FREQ, PCT))))
}
pvalue <- function(x, ...) {
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        if (length(levels(g)) > 2) {
            # 使用 ANOVA 如果 g 的因子数量超过2
            fit <- aov(y ~ g)
            p <- summary(fit)[[1]][["Pr(>F)"]][1]
        } else {
            # 使用 t 检验 如果 g 的因子数量为2
            p <- t.test(y ~ g)$p.value
        }
    } else {
        p <- chisq.test(table(y, g))$p.value 
    }
    c(sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}


#导出格式调整
export_to_excel <- function(data, file, sheet) {
  if (file.exists(file)) {
    # Load existing workbook
    wb <- loadWorkbook(file)
    # Check if worksheet already exists
    if (tolower(sheet) %in% tolower(names(wb))) {
      # Delete existing worksheet
      removeWorksheet(wb, sheet)
    }
  } else {
    # Create new workbook
    wb <- createWorkbook()
  }
  # Add new worksheet
  addWorksheet(wb, sheet)
  # Write data to new worksheet
  writeData(wb, sheet, as.data.frame(data), rowNames = TRUE) 
  # Save workbook
  saveWorkbook(wb, file, overwrite = TRUE)
}
#格式调整结束
custom_theme <- function() {
  theme_survminer() %+replace%
    theme(
      plot.title=element_text(hjust=0.5,size=16),
      legend.text = element_text(size = 14),
      axis.text = element_text(size=16)
    )
}
# 定义计算rate_difference_bh的函数
rate_diff_func <- function(data, indices) {
  # 获取bootstrap样本
  sample_data <- data[indices, ]
  
  # 重新计算加权死亡率
  weighted_case_mortality <- weighted.mean(sample_data$death_lm[sample_data$case_control == 1], sample_data$weight[sample_data$case_control == 1])
  weighted_control_mortality <- weighted.mean(sample_data$death_lm[sample_data$case_control == 0], sample_data$weight[sample_data$case_control == 0])
  
  # 计算rate_difference_bh
  rate_difference_bh <- weighted_case_mortality - weighted_control_mortality
  return(rate_difference_bh)
}
calculate_weighted_mortality_rate_difference <- function(data) {
  # 计算病例组的加权死亡率
  weighted_case_mortality <- weighted.mean(data$death_lm[data$case_control == 1], data$weight[data$case_control == 1])
  
  # 计算对照组的加权死亡率
  weighted_control_mortality <- weighted.mean(data$death_lm[data$case_control == 0], data$weight[data$case_control == 0])
  
  # 计算死亡率差异
  rate_difference <- weighted_case_mortality - weighted_control_mortality
  
  # 返回一个包含结果的列表
  return(data.frame(weighted_case_mortality = weighted_case_mortality,
                    weighted_control_mortality = weighted_control_mortality,
                    rate_difference = rate_difference))
}


```


#0.2数据准备
```{r}
#CLHLS数据库
a<-read_xlsx("/Users/yilin/Documents/文章/CLHLS/分析数据库/clhls_stemi.xlsx") %>% mutate(newdeath=death_18, followupyear = case_when(
        FUy <= 5 & newdeath == 0 ~ FUy,
      FUy <= 5 & newdeath == 1 ~ FUy,
      FUy > 5 & newdeath == 0 ~ 5,
      FUy > 5 & newdeath == 1 ~ 5,
      TRUE ~ NA_real_
    ), followupday=followupyear *365.25,
    death = case_when(
       FUy <= 5 & newdeath == 1 ~ 1,
      TRUE ~ 0
    ),
    across(c(diabetes,hyp,smoke,sex,ID,urban),as.factor),source="clhls")%>% dplyr::select(ID,sex,age,urban,diabetes,hyp,smoke,sex,death,followupyear,followupday,source)#charls数据库

b<-read_sas("/Users/yilin/Documents/文章/PURE/Analysis Datasets/total.sas7bdat") %>% 
  filter(!is.na(ASEX)|!is.na(age))%>%#47931-47930=1
 filter(ADCHD!=2)%>% # 47930-45001=2929
filter(!is.na(fdate))%>%  #45001-44818=183
  mutate(FUy=fday_dth/365.25,
       followupyear = case_when(
        FUy <= 5 & newdeath == 0 ~ FUy,
      FUy <= 5 & newdeath == 1 ~ FUy,
      FUy > 5 & newdeath == 0 ~ 5,
      FUy > 5 & newdeath == 1 ~ 5,
      TRUE ~ NA_real_
    ), followupday=followupyear *365.25,
    death = case_when(
       FUy <= 5 & newdeath == 1 ~ 1,
      TRUE ~ 0
    ),urban=if_else(location==1,1,0),edu=educ,smoke=if_else(smoke=="",NA,smoke),
    ID=idno,sex=ASEX,across(c(diabetes,hyp,smoke,sex,ID,urban,edu,gxz),as.factor),source="PURE",case_control=0
    ) %>% dplyr::select(ID,sex,age,diabetes,hyp,smoke,sex,death,followupyear,followupday,source,urban,edu,gxz,case_control) #PURE数据库 

#营养数据库
c<-read_sas("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/c.sas7bdat") %>% 
   mutate(FUy=FUt,
          newdeath=death,
          death=0,
        followupyear = case_when(
        FUy <= 5 & newdeath == 0 ~ FUy,
      FUy <= 5 & newdeath == 1 ~ FUy,
      FUy > 5 & newdeath == 0 ~ 5,
      FUy > 5 & newdeath == 1 ~ 5,
      TRUE ~ NA_real_
    ), followupday=followupyear *365.25,
    death = case_when(
       FUy <= 5 & newdeath == 1 ~ 1,
      TRUE ~ 0
    ),followupday=followupyear*365.25,ID=IDind,sex=GENDER,age=age1,across(c(diabetes,hyp,smoke,sex,ID,urban,edu),as.factor),source="CHNS")%>% dplyr::select(ID,sex,age,diabetes,hyp,smoke,sex,death,followupyear,followupday,source,edu,urban)#营养数据库

d<-read_xlsx("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/charls.xlsx") %>% mutate(newdeath=death, followupyear = case_when(
        FUy <= 5 & newdeath == 0 ~ FUy,
      FUy <= 5 & newdeath == 1 ~ FUy,
      FUy > 5 & newdeath == 0 ~ 5,
      FUy > 5 & newdeath == 1 ~ 5,
      TRUE ~ NA_real_
    ), followupday=followupyear *365.25,
    death = case_when(
       FUy <= 5 & newdeath == 1 ~ 1,
      TRUE ~ 0
    ),
    across(c(diabetes,hyp,smoke,sex,ID,urban,edu),as.factor),source="charls")%>% dplyr::select(ID,sex,edu,age,urban,diabetes,hyp,smoke,sex,death,followupyear,followupday,source)#charls数据库

cami5y<-read_sas("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/cami5y.sas7bdat") %>% mutate(FUy=followyear,newdeath=death_7y,
  followupyear = case_when(
        FUy <= 5 & newdeath == 0 ~ FUy,
      FUy <= 5 & newdeath == 1 ~ FUy,
      FUy > 5 & newdeath == 0 ~ 5,
      FUy > 5 & newdeath == 1 ~ 5,
      TRUE ~ NA_real_
    ), 
  followupday=followupyear *365.25,
    death = case_when(
       FUy <= 5 & newdeath == 1 ~ 1,
      TRUE ~ 0
    ),jyy_2y=case_when(VAR51 == 1 |VAR53 == 1 | VAR54 == 1 ~ 1,  
      is.na(VAR51) & is.na(VAR53) & is.na(VAR54) ~ NA_real_, # 三个条件均为 NA 则为 NA
      TRUE ~ 0 ),
    anti_0d = ifelse(grepl("阿司匹林|氯吡格雷", T14Q01208), 1, 0),
    beta_0d = ifelse(grepl("β受体阻滞剂", T14Q01208), 1, 0),
    statin_0d = ifelse(grepl("他汀类药物", T14Q01208), 1, 0),
    across(starts_with("T15Q1128_"), ~ ifelse(. == "是"|. == "间断或暂停又恢复", 1, 0)),
    across(starts_with("T15Q1132_"), ~ ifelse(. == "是"|. == "间断或暂停又恢复", 1, 0)),
    across(starts_with("T15Q1145_"), ~ ifelse(. == "是"|. == "间断或暂停又恢复", 1, 0)),
    across(starts_with("T15Q1148_"), ~ ifelse(. == "是"|. == "间断或暂停又恢复", 1, 0)),
    anti_30d=ifelse(T15Q1128_1==1|T15Q1132_1==1,1,0),
    anti_6m=ifelse(T15Q1128_2==1|T15Q1132_2==1,1,0),
    anti_12m=ifelse(T15Q1128_3==1|T15Q1132_3==1,1,0),
    anti_18m=ifelse(T15Q1128_4==1|T15Q1132_4==1,1,0),
    anti_24m=ifelse(T15Q1128_5==1|T15Q1132_5==1,1,0),
    beta_30d=ifelse(T15Q1148_1==1,1,0), 
    beta_6m=ifelse(T15Q1148_2==1,1,0),
    beta_12m=ifelse(T15Q1148_3==1,1,0),
    beta_18m=ifelse(T15Q1148_4==1,1,0),
    beta_24m=ifelse(T15Q1148_5==1,1,0),
    statin_30d=ifelse(T15Q1145_1==1,1,0), 
    statin_6m=ifelse(T15Q1145_2==1,1,0), 
    statin_12m=ifelse(T15Q1145_3==1,1,0), 
    statin_18m=ifelse(T15Q1145_4==1,1,0), 
    statin_24m=ifelse(T15Q1145_5==1,1,0), 
    #followupyear=followyear,followupday=flupt7y,
  ID=subjectid,age=age1,across(c(diabetes,hyp,smoke,sex,ID),as.factor),case_control=1,source="cami") %>% #cami5y数据库，已经只筛选了stemi ,starts_with("anti_"),starts_with("beta_"),starts_with("statin_")
mutate(across(c(edu,diabetes,hyp,gxz,smoke,quitsmoke,familyhis,obesity,cvd_his,ckd_his,time_12h_admi,time_3h_admi,LVEF40,cardiac_arrest,killip,fibri,primary_PCI,all_PCI,all_CABG,aspirin_ry,p2y_ry,statin_ry, beta_ry,ca2_ry,acei_arb_ry,jyy_2y),as.factor))
#,sex=factor(sex, levels = c(1, 2), labels = c("Male", "Female")



# 定义 prepare_data 函数并移除对 case_control 的直接赋值
prepare_data <- function(data) {
  data %>%
    mutate(
      followupday = if_else(followupday <= 0, 0.01, followupday),
      followupyear = if_else(followupyear <= 0, 0.001, followupyear),
      agegrp = case_when(
        sex == 1 & age < 65 ~ 1,
        sex == 1 & age >= 65 & age < 80 ~ 2,
        sex == 1 & age >= 80 ~ 3,
        sex == 2 & age < 65 ~ 1,
        sex == 2 & age >= 65 & age < 80 ~ 2,
        sex == 2 & age >= 80 ~ 3
      ),
      agegrp_label = case_when(
        sex == 1 & age < 65 ~ "Men <65 years",
        sex == 1 & age >= 65 & age < 80 ~ "Men 65-79 years",
        sex == 1 & age >= 80 ~ "Men >=80 years",
        sex == 2 & age < 65 ~ "Women <65 years",
        sex == 2 & age >= 65 & age < 80 ~ "Women 65-79 years",
        sex == 2 & age >= 80 ~ "Women >=80 years"
      ),
      across(c(agegrp, agegrp_label), as.factor)
    )
}

control<-bind_rows(a,b,c,d) %>% mutate(case_control=0)
#全人群
merged_data <- bind_rows(cami5y, control) %>% prepare_data()
#primary_pci
ppci <- cami5y %>% filter(primary_PCI == 1) %>% mutate(source = "ppci")
Mdata_ppci <- bind_rows(ppci, control) %>% prepare_data() 
#溶栓治疗
fibri<- cami5y %>% filter(fibri == 1) %>% mutate(source = "fibri")
Mdata_fibri <- bind_rows(fibri, control) %>% prepare_data()
#保守治疗
bs<- cami5y %>% filter(bszl == 1) %>% mutate(source = "bs")
Mdata_bs <- bind_rows(bs, control) %>% prepare_data()

write_xlsx(control,path="/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/control.xlsx")
write_xlsx(merged_data,path="/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/merged_data.xlsx")
write_xlsx(Mdata_ppci,path="/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/Mdata_ppci.xlsx")
write_xlsx(Mdata_fibri,path="/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/Mdata_fibri.xlsx")
write_xlsx(Mdata_bs,path="/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/Mdata_bs.xlsx")
```
#0.3.1匹配stemi（全）人群
```{r}


weighted.mean(matched_data1$age)#optimal计算出来是64.38

matched_data1 <- match.data(m.out1,data= merged_data) %>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))
#匹配的过程在SAS软件中完成

matched_data1<-read_sas("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/matched_data1.sas7bdat") %>% mutate(weight=`_MATCHWGT_`,across(c(sex,edu,diabetes,hyp,gxz,smokec,quitsmoke,familyhis,obesity,cvd_his,ckd_his,time_12h_admi,time_3h_admi,LVEF40,cardiac_arrest,killip,fibri,primary_PCI,all_PCI,all_CABG,aspirin_ry,p2y_ry,statin_ry, beta_ry,ca2_ry,acei_arb_ry,jyy_2y),as.factor))


#landmark1,在0-30天內的情况
LM1<-matched_data1 %>% mutate(FUds= case_when(
      followupday <=30 ~ followupday ,
      followupday  >30 ~ 30,
      TRUE ~ NA),
      FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >30 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weighgt=ifelse(case_control==0,1 /(matchid_size-1),1))


#landmark2,在30-90天內的情况
LM2 <- matched_data1 %>%
  # 标记是否病例在30天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有30天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在30天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否对照在30天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在30天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_30days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_30days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在30天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>%
  # 创建 follow-up days 和修正的死亡标记
  mutate(FUds = case_when(
    followupday <= 90 ~ followupday,
    followupday > 90 ~ 90,
    TRUE ~ NA_real_  # 确保 NA 类型正确
  ),
  death_lm = case_when(
    followupday > 90 & death == 1 ~ 0,  # 超过90天的死亡设置为0
    TRUE ~ death
  ))%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


LM3 <- matched_data1 %>%
  # 创建一个新变量标记是否病例在90天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有90天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在90天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在90天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在90天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在90天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))
#0-1y
LM_3_1 <- matched_data1 %>% mutate(FUds= case_when(
      followupday <=365 ~ followupday ,
      followupday  >365 ~ 365,
      TRUE ~ NA),
      FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >365 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#1y-5y
LM_3_2 <- matched_data1 %>%
  # 创建一个新变量标记是否病例在1y内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有1y内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在1y内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在1y内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在1y内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在1y内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#landmark1,在0-90天內的情况
LM4<-matched_data1 %>% mutate(FUds= case_when(
      followupday <=90 ~ followupday ,
      followupday  >90 ~ 90,
      TRUE ~ NA),
      FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >90 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

cox_model_clustered <- coxph(Surv(followupday, death) ~ case_control+strata(matchid),cluster =source, data = matched_data1, weights = weight)
cox_model_clustered1 <- coxph(Surv(FUds, death_lm) ~ case_control, data = LM1, weights = weight)
cox_model_clustered2 <- coxph(Surv(FUds, death_lm) ~ case_control, data = LM2,  weights =weight)
cox_model_clustered3 <- coxph(Surv(FUds, death_lm) ~ case_control, data = LM3, weights = weight)
fit <- survfit(Surv(FUds, death_lm) ~ case_control, data = LM1, weights = weight)
plot(fit, fun = "cloglog", xlab = "Time", ylab = "log(-log(Survival))")

zph_model0<-cox.zph(cox_model_clustered)#LM1不符合比例风险假设
print(zph_model0)
zph_model1 <-cox.zph(cox_model_clustered1)#LM1不符合比例风险假设
print(zph_model1)
zph_model2 <-cox.zph(cox_model_clustered2)#LM2符合比例风险假设
print(zph_model2)
zph_model3 <-cox.zph(cox_model_clustered3)#LM3不符合比例风险假设
print(zph_model3)
# 绘制生存曲线
plot(zph_model1)
plot(zph_model2)
plot(zph_model3)

 summary(cox_model_clustered)
cox_model_weighted_stratified <- coxph(Surv(FUds, death_lm) ~ case_control+ strata(matchid), data = LM1,  weights = weight)
summary(cox_model_weighted_stratified)


#时间加速模型，根本跑不出来
aft_model_lognormal1 <- survreg(Surv(FUds, death_lm) ~ case_control + strata(matchid), 
                               data = LM1, weights = weight, dist = "weibull")
aft_model_lognormal2 <- survreg(Surv(FUds, death_lm) ~ case_control + strata(matchid), 
                               data = LM2, weights = weight, dist = "weibull")
aft_model_lognormal3 <- survreg(Surv(FUds, death_lm) ~ case_control + strata(matchid), 
                               data = LM3, weights = weight, dist = "weibull")
summary(aft_model_lognormal)
#加入时依变量
cox_model_time_dep <- coxph(Surv(FUds, death_lm) ~ case_control+tt(case_control) + 
                             strata(matchid), data = LM1, weights = weight, 
                            tt = function(x, t, ...) x * log(t))
# 获取模型摘要
summary_cox <- summary(cox_model_time_dep)
exp(coef(cox_model_time_dep))
exp(confint(cox_model_time_dep))
# 定义函数来计算HR及其置信区间
HR_cal <- function(t) {
  # 提取系数和标准误
  coef_case_control <- summary_cox$coefficients["case_control", "coef"]
  se_case_control <- summary_cox$coefficients["case_control", "se(coef)"]
  coef_tt <- summary_cox$coefficients["tt(case_control)", "coef"]
  se_tt <- summary_cox$coefficients["tt(case_control)", "se(coef)"]
  
  # 计算HR
  HR <- exp(coef_case_control + coef_tt * log(t))
  

  
  # 计算对数标准误
HR_se <-   HR*sqrt(se_case_control^2 + (log(t)^2 * se_tt^2))
  
  # 使用1.96计算95%的置信区间
  lower_bound <- exp( coef_case_control-coef_tt*log(t)- 1.96 * HR_se)
  upper_bound <- exp(coef_case_control-coef_tt*log(t)+ 1.96 * HR_se)
  
  # 返回HR及其置信区间，保留两位小数
  return(c(HR = round(HR, 2), CI_lower = round(lower_bound, 2), CI_upper = round(upper_bound, 2)))
}

# 示例使用
HR_results <- HR_cal(30)

# 输出HR及其置信区间
HR_results


cox_model_time_dep2 <- coxph(Surv(FUds, death_lm) ~ case_control + tt(case_control) + 
                             strata(matchid), data = LM2, weights = weight, 
                            tt = function(x, t, ...) x * log(t))
summary_cox <-summary(cox_model_time_dep2)
HR12=HR_cal(31)
HR2=HR_cal(90)
# 示例使用
HR_cal(90)


cox_model_time_dep3 <- coxph(Surv(FUds, death_lm) ~ case_control + tt(case_control) + 
                             strata(matchid), data = LM3, weights = weight, 
                            tt = function(x, t, ...) x * log(t))
summary_cox <-summary(cox_model_time_dep3)
HR21=HR_cal(91)
HR3=HR_cal(365*7)
#计算相对生存率
# 创建生存对象
surv_object <- Surv(LM1$FUds, LM1$death_lm)

# 计算加权的生存模型
fit_case_control <- survfit(Surv(FUds, death_lm) ~ case_control, data = LM1, weights = weight)

# 检查 fit_case_control 的分组标签
print(fit_case_control$strata)
###################################相对生存率图绘制开始
# 提取病例组和对照组的生存率
summary_fit <- summary(fit_case_control)
# 提取病例组的观察生存率
observed_survival_case <- summary_fit$surv[summary_fit$strata == "case_control=1"]
# 提取对照组的观察生存率
observed_survival_control <- summary_fit$surv[summary_fit$strata == "case_control=0"]


# 选择要比较的时间点
time_point <- 30  # 假设您想在第30天计算

# 提取在该时间点的生存率
if (length(observed_survival_case) >= time_point) {
  survival_case_at_time_point <- observed_survival_case[time_point]
} else {
  stop("观察生存率病例组在该时间点没有值")
}

if (length(observed_survival_control) >= time_point) {
  survival_control_at_time_point <- observed_survival_control[time_point]
} else {
  stop("观察生存率对照组在该时间点没有值")
}

# 计算相对生存率
relative_survival_rate <- survival_case_at_time_point / survival_control_at_time_point

# 输出相对生存率
print(relative_survival_rate)
# 假设有一个时间变量 time
time <- seq(0, length(relative_survival_rate) - 1)  # 这里的时间点可以是0到n的序列

# 创建数据框
relative_survival_data <- data.frame(time = time, RSR = relative_survival_rate)
library(ggplot2)

# 绘制相对生存曲线
ggplot(relative_survival_data, aes(x = time, y = RSR)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  labs(title = "Relative Survival Curve",
       x = "Time (Days)",
       y = "Relative Survival Rate") +
  theme_minimal() +
  ylim(0, 1)  # 确保Y轴范围在0到1之间
# 假设 ci_lower 和 ci_upper 是下限和上限的置信区间
relative_survival_data$ci_lower <- ci_lower
relative_survival_data$ci_upper <- ci_upper

# 绘制相对生存曲线与置信区间
ggplot(relative_survival_data, aes(x = time, y = RSR)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2, fill = "lightblue") +
  labs(title = "Relative Survival Curve with Confidence Intervals",
       x = "Time (Days)",
       y = "Relative Survival Rate") +
  theme_minimal() +
  ylim(0, 1)  # 确保Y轴范围在0到1之间

##############################################相对生存率图绘制结束



# 结果汇总
time_intervals <- summary(fit_case_control)$time  # 时间间隔
result <- data.frame(
  time = time_intervals,
  observed_survival_case = observed_survival_case,
  expected_survival = observed_survival_control,
  relative_survival_rate = relative_survival_rate
)

print(result)



# 安装并加载flexsurv包
install.packages("flexsurv")
library(flexsurv)
LM1$FUds[LM1$FUds <= 0] <- 0.001  # 将生存时间设置为一个非常小的正数

#  拟合Weibull分布的生存模型
fit <- flexsurvreg(Surv(FUds, death_lm) ~ case_control+age+sex, data = LM3, 
                   dist = "weibull", weights = weight)

# 绘制生存曲线
plot(fit, xlab = "Time", ylab = "Survival Probability", col = c("blue", "red"))
legend("topright", legend = levels(as.factor(LM1$case_control)), col = c("blue", "red"), lty = 1)
# 查看结果
summary(fit)
# 获取 case_control 的回归系数
coef_case_control <- flex_model2$res[["case_control", "est"]]

# 计算HR (Hazard Ratio) - 通过指数函数得到HR
HR <- exp(coef_case_control)
HR
library(flexsurv)
#Weibull的AIC值最小更符合
# 拟合多种分布
fit_weibull <- flexsurvreg(Surv(FUds, death) ~ case_control, data = LM1, dist = "weibull")
fit_exponential <- flexsurvreg(Surv(FUds, death) ~ case_control, data = LM1, dist = "exponential")
fit_lognormal <- flexsurvreg(Surv(FUds, death) ~ case_control, data = LM1, dist = "lognormal")

# 比较 AIC 值
aic_values <- c(AIC(fit_weibull), AIC(fit_exponential), AIC(fit_lognormal))
names(aic_values) <- c("Weibull", "Exponential", "Log-normal")

# 打印 AIC 值
print(aic_values)
table(matched_data1$death)
```
#0.3.2匹配primary PCI人群
```{r}

matched_data2<-read_sas("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/matched_data2.sas7bdat") %>% mutate(weight=`_MATCHWGT_`,across(c(sex,edu,diabetes,hyp,gxz,smokec,quitsmoke,familyhis,obesity,cvd_his,ckd_his,time_12h_admi,time_3h_admi,LVEF40,cardiac_arrest,killip,fibri,primary_PCI,all_PCI,all_CABG,aspirin_ry,p2y_ry,statin_ry, beta_ry,ca2_ry,acei_arb_ry,jyy_2y),as.factor))


#landmark1,在0-30天內的情况
LM_ppci1<-matched_data2 %>% mutate(FUds= case_when(
      followupday <=30 ~ followupday ,
      followupday  >30 ~ 30,
      TRUE ~ NA),
       FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >30 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


#landmark2,在30-90天內的情况
LM_ppci2 <- matched_data2 %>%
  # 标记是否病例在30天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有30天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在30天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否对照在30天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在30天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_30days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_30days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在30天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>%
  # 创建 follow-up days 和修正的死亡标记
  mutate(FUds = case_when(
    followupday <= 90 ~ followupday,
    followupday > 90 ~ 90,
    TRUE ~ NA_real_  # 确保 NA 类型正确
  ),
  death_lm = case_when(
    followupday > 90 & death == 1 ~ 0,  # 超过90天的死亡设置为0
    TRUE ~ death
  ))%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


LM_ppci3 <- matched_data2 %>%
  # 创建一个新变量标记是否病例在90天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有90天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在90天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在90天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在90天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在90天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))
#0-1y
LM_ppci3_1 <- matched_data2 %>% mutate(FUds= case_when(
      followupday <=365 ~ followupday ,
      followupday  >365 ~ 365,
      TRUE ~ NA),
      FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >365 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#1y-5y
LM_ppci3_2 <- matched_data2 %>%
  # 创建一个新变量标记是否病例在1y内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有1y内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在1y内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在1y内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在1y内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在1y内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


#landmark1,在0-90天內的情况
LM_ppci4<-matched_data2 %>% mutate(FUds= case_when(
      followupday <=90 ~ followupday ,
      followupday  >90 ~ 90,
      TRUE ~ NA),
       FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >90 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))



```
#0.3.3匹配溶栓人群
```{r}
           
matched_data3<-read_sas("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/matched_data3.sas7bdat") %>% mutate(res_fibri=if_else(T5Q0415=="STEMI溶栓失败后补救性PCI",1,0),
  weight=`_MATCHWGT_`,across(c(sex,edu,diabetes,hyp,gxz,smokec,quitsmoke,familyhis,obesity,cvd_his,ckd_his,time_12h_admi,time_3h_admi,LVEF40,cardiac_arrest,killip,fibri,primary_PCI,all_PCI,all_CABG,aspirin_ry,p2y_ry,statin_ry, beta_ry,ca2_ry,acei_arb_ry,jyy_2y,res_fibri),as.factor))


#landmark1,在0-30天內的情况
LM_f1<-matched_data3 %>% mutate(FUds= case_when(
      followupday <=30 ~ followupday ,
      followupday  >30 ~ 30,
      TRUE ~ NA),
       FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >30 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


#landmark2,在30-90天內的情况
LM_f2 <- matched_data3 %>%
  # 标记是否病例在30天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有30天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在30天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否对照在30天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在30天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_30days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_30days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在30天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>%
  # 创建 follow-up days 和修正的死亡标记
  mutate(FUds = case_when(
    followupday <= 90 ~ followupday,
    followupday > 90 ~ 90,
    TRUE ~ NA_real_  # 确保 NA 类型正确
  ),
  death_lm = case_when(
    followupday > 90 & death == 1 ~ 0,  # 超过90天的死亡设置为0
    TRUE ~ death
  ))%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


LM_f3 <- matched_data3 %>%
  # 创建一个新变量标记是否病例在90天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有90天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在90天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在90天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在90天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在90天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#0-1y
LM_f3_1 <- matched_data3 %>% mutate(FUds= case_when(
      followupday <=365 ~ followupday ,
      followupday  >365 ~ 365,
      TRUE ~ NA),
      FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >365 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#1y-5y
LM_f3_2 <- matched_data3 %>%
  # 创建一个新变量标记是否病例在1y内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有1y内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在1y内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在1y内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在1y内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在1y内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#landmark1,在0-90天內的情况
LM_f4<-matched_data3 %>% mutate(FUds= case_when(
      followupday <=90 ~ followupday ,
      followupday  >90 ~ 90,
      TRUE ~ NA),
       FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >90 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))



```
#0.3.4匹配保守治疗人群
```{r}

                     
matched_data4<-read_sas("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/数据库/分析库/matched_data4.sas7bdat") %>% mutate(weight=`_MATCHWGT_`,across(c(sex,edu,diabetes,hyp,gxz,smokec,quitsmoke,familyhis,obesity,cvd_his,ckd_his,time_12h_admi,time_3h_admi,LVEF40,cardiac_arrest,killip,fibri,primary_PCI,all_PCI,all_CABG,aspirin_ry,p2y_ry,statin_ry, beta_ry,ca2_ry,acei_arb_ry,jyy_2y),as.factor))

#landmark1,在0-30天內的情况
LM_b1<-matched_data4 %>% mutate(FUds= case_when(
      followupday <=30 ~ followupday ,
      followupday  >30 ~ 30,
      TRUE ~ NA),
       FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >30 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


#landmark2,在30-90天內的情况
LM_b2 <- matched_data4 %>%
  # 标记是否病例在30天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有30天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在30天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否对照在30天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 30 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在30天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_30days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_30days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在30天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>%
  # 创建 follow-up days 和修正的死亡标记
  mutate(FUds = case_when(
    followupday <= 90 ~ followupday,
    followupday > 90 ~ 90,
    TRUE ~ NA_real_  # 确保 NA 类型正确
  ),
  death_lm = case_when(
    followupday > 90 & death == 1 ~ 0,  # 超过90天的死亡设置为0
    TRUE ~ death
  ))%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))


LM_b3 <- matched_data4 %>%
  # 创建一个新变量标记是否病例在90天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有90天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在90天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在90天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 90 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在90天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在90天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#0-1y
LM_b3_1 <- matched_data4 %>% mutate(FUds= case_when(
      followupday <=365 ~ followupday ,
      followupday  >365 ~ 365,
      TRUE ~ NA),
      FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >365 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#1y-5y
LM_b3_2 <- matched_data4 %>%
  # 创建一个新变量标记是否病例在1y内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid标记是否有1y内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove, na.rm = TRUE)) %>%
  ungroup() %>%
  # 删除有病例在1y内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  # 标记是否所有对照都在1y内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 365 & death == 1, 1, 0)) %>%
  # 对每个matchid的对照，检查是否所有对照都在1y内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove, na.rm = TRUE)) %>%
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  # 删除所有对照都在1y内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>% 
  mutate(FUds=followupday,death_lm=death)%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))

#landmark1,在0-90天內的情况
LM_b4<-matched_data4 %>% mutate(FUds= case_when(
      followupday <=90 ~ followupday ,
      followupday  >90 ~ 90,
      TRUE ~ NA),
       FUds=if_else(FUds==0,0.0001,FUds),
    death_lm = case_when(
     followupday >90 & death == 1 ~ 0,
      TRUE ~ death)
    )%>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% mutate(weight=ifelse(case_control==0,1 /(matchid_size-1),1))



```
#0.3.2.2FigureS3匹配后的年龄和性别图
```{r}
# 打开 PDF 设备
pdf("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS3.pdf", width = 8, height = 8)

# 设置 2 行 2 列的布局
par(mfrow = c(2, 2))  # 每页 2x2 布局

# 绘制图形
plot(m.out1, type = "density", interactive = FALSE, which.xs = ~age + sex, main = "Plot 1")
plot(m.out2, type = "density", interactive = FALSE, which.xs = ~age + sex, main = "Plot 2")
plot(m.out3, type = "density", interactive = FALSE, which.xs = ~age + sex, main = "Plot 3")
plot(m.out4, type = "density", interactive = FALSE, which.xs = ~age + sex, main = "Plot 4")

# 关闭 PDF 设备
dev.off()



```
##0.3.2除性别年龄以外再匹配高血压、吸烟、糖尿病三种危险因素
```{r}
# 使用MatchIt进行匹配，允许年龄差异在±0.5岁，性别完全匹配
test <- Mdata_ppci %>% filter(!is.na(hyp)&!is.na(smoke)&!is.na(diabetes))
m.out2 <- matchit(case_control ~ age + sex+hyp+smoke+diabetes, data = test, method = "full", distance = "glm", link = "probit")
# 提取匹配后的数据
summary(m.out2, un = FALSE)
matched_data2_1 <- match.data(m.out) 


h

LM3 <- matched_data2 %>%
  # 创建一个新变量标记是否病例在90天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 90 & death == 1, 1, 0)) %>%
  
  # 对每个matchid标记是否有90天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove)) %>%
  ungroup() %>%
  
  # 删除有病例在90天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  
  # 标记是否所有对照都在90天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 90 & death == 1, 1, 0)) %>%
  
  # 对每个matchid的对照，检查是否所有对照都在90天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove)) %>%
  
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  
  # 删除所有对照都在90天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0)

# 创建生存对象
surv_object <- Surv(time = LM3$followupday, event = LM3$death)

# 进行 Cox 比例风险回归分析
cox_model3 <- coxph(surv_object ~ case_control + age + sex + strata(matchid), data = LM3)

# 输出模型结果
summary(cox_model3)

CreateTableOne(vars = c("death"),factorVars =c("death")  ,strata = c("case_control"),data =LM3, includeNA = T,addOverall=T)


# 使用MatchIt进行匹配，允许年龄差异在±1岁，性别完全匹配
m.out1 <- matchit(case_control ~ age + sex, data = merged_data, 
                 method = "nearest", ratio = 4, 
                 caliper = c(age =1))
# 提取匹配后的数据
matched_data1 <- match.data(m.out1)

# 拟合灵活参数生存模型
flex_model <- flexsurvreg(Surv(followupyear, death) ~ age + case_control + strata(matchid), 
                           data = matched_data, 
                           dist = "weibull")

# 显示模型结果
summary(flex_model)

```

```{r}
# 使用MatchIt进行匹配，允许年龄差异在±0.5岁，性别完全匹配
m.out <- matchit(case_control ~ age + sex, data = merged_data, 
                 method = "nearest", ratio = 4, 
                 caliper = c(age = 0.5))
# 提取匹配后的数据
summary(m.out,un = FALSE)
plot(m.out1, type = "jitter", interactive = FALSE)
plot(m.out1, type = "density", interactive = FALSE,
     which.xs = ~age + sex)

# 使用MatchIt进行匹配，允许年龄差异在±0.5岁，性别完全匹配
test <- merged_data %>% filter(!is.na(hyp)&!is.na(smoke)&!is.na(diabetes))
m.out2 <- matchit(case_control ~ age + sex+hyp+smoke+diabetes, data = test, method = "full", distance = "glm", link = "probit")
# 提取匹配后的数据
summary(m.out2, un = FALSE)


matched_data1 <- match.data(m.out) %>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% filter(matchid_size==4) 
test <- matched_data %>% group_by(matchid) %>% # 计算每个matchid的数量
  mutate(matchid_size = n()) %>% 
  ungroup() %>% filter(matchid_size==4&case_control==1) 
table(test$matchid_size)
#landmark1,在0-30天內的情况
LM1<-matched_data1 %>% mutate(FUds= case_when(
      followupday <=30 ~ followupday ,
      followupday  >30 ~ 30,
      TRUE ~ NA),
    death_lm = case_when(
     followupday >30 & death == 1 ~ 0,
      TRUE ~ death)
    )
CreateTableOne(vars = c("death_lm"),factorVars = c("death_lm"), strata = c("case_control"),data =LM1, includeNA = T,addOverall=T)
# 创建生存对象
surv_object <- Surv(time = LM1$FUds, event = LM1$death_lm)

# 进行 Cox 比例风险回归分析
cox_model1 <- coxph(surv_object ~ case_control + age + sex + strata(matchid), data = LM1)

# 输出模型结果
summary(cox_model1)

table(LM1$death)
data1<-data %>% filter(STEMI==1)
#landmark2,在30-90天內的情况
LM2 <- matched_data1 %>%
  # 标记是否病例在30天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 30 & death == 1, 1, 0)) %>%
  
  # 对每个matchid标记是否有30天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove)) %>%
  ungroup() %>%
  
  # 删除有病例在30天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  
  # 标记是否对照在30天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 30 & death == 1, 1, 0)) %>%
  
  # 对每个matchid的对照，检查是否所有对照都在30天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_30days = max(control_to_remove)) %>%
  
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_30days == 1, 1, 0)) %>%
  ungroup() %>%
  
  # 删除所有对照都在30天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0) %>%
  
  # 创建 follow-up days 和修正的死亡标记
  mutate(FUds = case_when(
    followupday <= 90 ~ followupday,
    followupday > 90 ~ 90,
    TRUE ~ NA_real_  # 确保 NA 类型正确
  ),
  death_lm = case_when(
    followupday > 90 & death == 1 ~ 0,  # 超过90天的死亡设置为0
    TRUE ~ death
  ))
# 创建生存对象
surv_object <- Surv(time = LM2$FUds, event = LM2$death_lm)

# 进行 Cox 比例风险回归分析
cox_model2 <- coxph(surv_object ~ case_control + age + sex + strata(matchid), data = LM2)

# 输出模型结果
summary(cox_model2)
CreateTableOne(vars = c("death_lm"), strata = c("case_control"),data =LM2, includeNA =T,addOverall=T)

LM3 <- matched_data1 %>%
  # 创建一个新变量标记是否病例在90天内死亡
  mutate(case_to_remove = ifelse(case_control == 1 & followupday <= 90 & death == 1, 1, 0)) %>%
  
  # 对每个matchid标记是否有90天内死亡的病例
  group_by(matchid) %>%
  mutate(case_to_remove_matchid = max(case_to_remove)) %>%
  ungroup() %>%
  
  # 删除有病例在90天内死亡的matchid
  filter(case_to_remove_matchid == 0) %>%
  
  # 标记是否所有对照都在90天内死亡
  mutate(control_to_remove = ifelse(case_control == 0 & followupday <= 90 & death == 1, 1, 0)) %>%
  
  # 对每个matchid的对照，检查是否所有对照都在90天内死亡
  group_by(matchid) %>%
  mutate(all_controls_dead_90days = max(control_to_remove)) %>%
  
  # 如果某个matchid中所有对照都死了，标记整个matchid为需要删除
  mutate(remove_whole_matchid = ifelse(all_controls_dead_90days == 1, 1, 0)) %>%
  ungroup() %>%
  
  # 删除所有对照都在90天内死亡的matchid（包括病例）
  filter(remove_whole_matchid == 0)

# 创建生存对象
surv_object <- Surv(time = LM3$followupday, event = LM3$death)

# 进行 Cox 比例风险回归分析
cox_model3 <- coxph(surv_object ~ case_control + age + sex + strata(matchid), data = LM3)

# 输出模型结果
summary(cox_model3)

CreateTableOne(vars = c("death"),factorVars =c("death")  ,strata = c("case_control"),data =LM3, includeNA = T,addOverall=T)


# 使用MatchIt进行匹配，允许年龄差异在±1岁，性别完全匹配
m.out1 <- matchit(case_control ~ age + sex, data = merged_data, 
                 method = "nearest", ratio = 4, 
                 caliper = c(age =1))
# 提取匹配后的数据
matched_data1 <- match.data(m.out1)

# 拟合灵活参数生存模型
flex_model <- flexsurvreg(Surv(followupyear, death) ~ age + case_control + strata(matchid), 
                           data = matched_data, 
                           dist = "weibull")

# 显示模型结果
summary(flex_model)

```
##0.3.3用逆概率加权的方法进行(不考虑)
```{r}
 matchit(case_control ~ age + sex, data = merged_data, 
                 method = "nearest", ratio = 4, 
                 caliper = c(age = 0.5))
# 使用logistic回归计算倾向评分
ps_model <- glm(case_control ~ age + sex, family = binomial(), matched_data1)

# 提取倾向评分
matched_data1$propensity_score <- ps_model$fitted.values


# 计算逆概率加权
matched_data1$weight2 <- ifelse(matched_data1$case_control == 1, 1 / matched_data1$propensity_score, 1 / (1 - matched_data1$propensity_score))

# 加权分析，比较死亡率
weighted_model <- glm(death ~ case_control, family = binomial(), data = matched_data1, weights = matched_data1$weight)
summary(weighted_model)
library(boot)


# 计算病例组和对照组的加权死亡率_1/10
weighted_case_mortality <- weighted.mean(matched_data1$death[matched_data1$case_control == 1], matched_data1$weight[matched_data1$case_control == 1])
weighted_control_mortality <- weighted.mean(matched_data1$death[matched_data1$case_control == 0], matched_data1$weight[matched_data1$case_control == 0])
# 计算死亡率差异
rate_difference_bh <- weighted_case_mortality - weighted_control_mortality

# 计算病例组和对照组的加权死亡率_倾向性评分
weighted_case_mortality <- weighted.mean(matched_data1$death[matched_data1$case_control == 1], matched_data1$weight2[matched_data1$case_control == 1])
weighted_control_mortality <- weighted.mean(matched_data1$death[matched_data1$case_control == 0], matched_data1$weight2[matched_data1$case_control == 0])
# 计算死亡率差异
rate_difference_ps <- weighted_case_mortality - weighted_control_mortality
# 输出置信区间
cat("加权死亡率差异的95%置信区间:", boot_ci$percent[4], "-", boot_ci$percent[5], "\n")

mean(matched_data1$death[matched_data1$case_control == 1])
mean(matched_data1$death[matched_data1$case_control == 0])
rate_difference_crude<-case_mortality_rate - control_mortality_rate





# 定义计算rate_difference_bh的函数
rate_diff_func <- function(data, indices) {
  # 获取bootstrap样本
  sample_data <- data[indices, ]
  
  # 重新计算加权死亡率
  weighted_case_mortality <- weighted.mean(sample_data$death[sample_data$case_control == 1], sample_data$weight[sample_data$case_control == 1])
  weighted_control_mortality <- weighted.mean(sample_data$death[sample_data$case_control == 0], sample_data$weight[sample_data$case_control == 0])
  
  # 计算rate_difference_bh
  rate_difference_bh <- weighted_case_mortality - weighted_control_mortality
  return(rate_difference_bh)
}

# 使用boot函数进行bootstrap
set.seed(123)  # 设置随机种子以保证结果可重复
bootstrap_results <- boot(data = matched_data1, 
                          statistic = rate_diff_func, 
                          R = 100)  # R为重复抽样的次数

# 获取95%置信区间
boot.ci(bootstrap_results, type = "perc")

```
#1.1.0Table1&TableS2-S3&TableS8 baseline
```{r}
# 为每个数据集添加一个新的列 'source' 来标记数据来源

data <- bind_rows(ppci, cami5y,fibri,bs)

vars <- c("age1","edu","diabetes","hyp","gxz","smokec","quitsmoke","familyhis","obesity","cvd_his","ckd_his","time_12h_admi","time_3h_admi","sbp1","hr1","LVEF40","cardiac_arrest","killip","fibri","primary_PCI","all_PCI","all_CABG","aspirin_ry","p2y_ry","statin_ry", "beta_ry","ca2_ry","acei_arb_ry","cr","ldlc","TC","glucose","HbA1c","sex")

## Create Table 1 stratified by trt
tableOne <- CreateTableOne(vars = vars, strata = c("source"),data =data, includeNA = F,addOverall=T)

# 将表格转换为数据框
tab1 <- as.data.frame(print(tableOne,showAllLevels = F, quote = FALSE, noSpaces = TRUE, missing = TRUE,contDigits = 1))


export_to_excel(tab1[,c(3,2,4:6,8)], "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/Table1.xlsx", "Sheet2")


summary(ppci$cr)
IQR(ppci$cr,na.rm=T)
summary(cami5y$cr)
IQR(cami5y$cr,na.rm=T)
summary(fibri$cr)
IQR(fibri$cr,na.rm=T)
summary(bs$cr)
IQR(bs$cr,na.rm=T)

 kruskal.test(cr ~ source, data = data)

#附表，营养数据的table1
 
vars <- c("age","sex","edu","urban","hyp","diabetes","smoke")
#data=control表示匹配前
tableOne <- CreateTableOne(vars = vars, data =control,  strata = c("source"),includeNA = T,addOverall=T)#CHNS的基线情况
tab1 <- as.data.frame(print(tableOne,showAllLevels = T, quote = FALSE, noSpaces = TRUE, missing = TRUE,contDigits = 2))
export_to_excel(tab1[,c(1:9)], "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS2.xlsx", "Sheet2")

vars <- c("age","sex","edu","urban","hyp","diabetes","smoke")
## Create Table 1 stratified by trt
#表示匹配后
tableOne <- matched_data1 %>% filter(case_control==0) %>% CreateTableOne(vars = vars, data =.,  strata = c("source"),includeNA = T,addOverall=T)#
tab1 <- as.data.frame(print(tableOne,showAllLevels = T, quote = FALSE, noSpaces = TRUE, missing = TRUE,contDigits = 2))
export_to_excel(tab1[,c(1:9)], "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS3.xlsx", "Sheet2")

vars <- c("age","sex","edu","hyp","diabetes","smoke")
factorVars <- c("sex", "edu",  "hyp", "diabetes", "smoke")
# 创建 survey design 对象
design <- matched_data1 %>% select(vars,"case_control","_MATCHWGT_") %>% svydesign(ids = ~1,data = ., weights = ~`_MATCHWGT_`)

tableOne <- svyCreateTableOne(vars = vars, data =design ,  strata = c("case_control"),includeNA = F,addOverall=T)#
tab1 <- as.data.frame(print(tableOne,showAllLevels = T, quote = FALSE, noSpaces = TRUE, missing = TRUE,contDigits = 2))
export_to_excel(tab1[,c(1:5)], "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS4.xlsx", "Sheet2")

```
#1.1.1Figure1累计5年生存曲线
```{r}
#将生存时间设置为一个非常小的正数

custom_theme <- function() {
  theme(
    text = element_text(family = "serif", size = 12),  # 使用serif字体
    panel.border = element_blank(),  # 移除所有边框
    axis.line.x = element_line(size = 0.5),  # 下边框
    axis.line.y = element_line(size = 0.5),   # 左边框
    axis.line = element_line(size = 0.5),               # 坐标轴线
    axis.ticks = element_line(size = 0.5),              # 坐标轴刻度线
    legend.position = "top",                            # 图例位置调整
    legend.title = element_blank(),                     # 去除图例标题
    panel.grid.major = element_blank(),                 # 移除主网格线
    panel.grid.minor = element_blank(),                 # 移除次网格线
    axis.text = element_text(size = 10),                # 坐标轴标签大小调整
    axis.title = element_text(size = 12)                # 坐标轴标题大小调整
  )
}
# 自定义绘制生存曲线的函数
# 自定义绘制生存曲线的函数
plot_survival_curve <- function(data, palette_colors, legend_labels) {
  # 不再使用svydesign设计对象
  
  # 生存模型
  surv_fit <- survfit(Surv(followupday, death) ~ case_control, data = data, weights = weight)
  
  # 绘制生存曲线
  plot <- ggsurvplot(
    surv_fit, data = data, conf.int = TRUE,
    palette = palette_colors, 
    xlab = "Follow-up days", ylab = "Death(%)",
    ggtheme = theme_bw(), legend.labs = legend_labels,
    fun = function(x) 100 * (1 - x)
  )
  
  # 自定义主题和刻度
  plot$plot <- plot$plot + custom_theme() +
    scale_y_continuous(limits = c(0, 30)) +
    scale_x_continuous(
      breaks = c(0, 30, 90, 365, 365 * 2, 365 * 3, 365 * 4, 365 * 5),
      labels = c(0, 30, 90, 365, 365 * 2, 365 * 3, 365 * 4, 365 * 5),
      expand = c(0.05, 0)  # 增加X轴两端的边距，防止标签重叠
    ) +
    geom_vline(xintercept = 30, linetype = "dashed", color = "gray") +
    geom_vline(xintercept = 90, linetype = "dashed", color = "gray") +
    guides(color = guide_legend(nrow = 2)) +  # 将图例分成两行
    theme(
      legend.position = "top",
      legend.text = element_text(size = 10),
      legend.key.height = unit(0.5, "cm"),  # 调整图例项之间的间距
      legend.spacing.y = unit(0.2, "cm"),    # 控制行间距
      legend.margin = margin(t = 15, b = -40, unit = "pt") # 向下移动图例
    )
  
  return(plot)
}

# 生成各组的生存曲线
p1 <- plot_survival_curve(
  matched_data1,
  palette_colors = c("#2E9FDF", "#CA6F62"),
  legend_labels = c("STEMI Patients", "Age- and Sex-Matched General Population")
)

p2 <- plot_survival_curve(
  matched_data2,
  palette_colors = c("#2E9FDF", "#CA6F62"),
  legend_labels = c("Patients treated with PPCI", "Age- and Sex-Matched General Population")
)

p3 <- plot_survival_curve(
  matched_data3,
  palette_colors = c("#2E9FDF", "#CA6F62"),
  legend_labels = c("Patients treated with Fibrinolysis", "Age- and Sex-Matched General Population")
)

p4 <- plot_survival_curve(
  matched_data4,
  palette_colors = c("#2E9FDF", "#CA6F62"),
  legend_labels = c("Patients treated without reperfusion", "Age- and Sex-Matched General Population")
)




p<-grid.arrange(p1$plot,p4$plot, p3$plot, p2$plot,ncol = 2)
ggsave("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/Figure1.pdf",plot=p,width=40,height=15, units = "cm")

```
#1.1.2FigureS4 用药的比例图
```{r}
table(cami5y$anti_12m)
# 假设您的数据框名为 cami5y，包含用药信息
# 转换数据为长格式
long_df <- cami5y %>%
  select(anti_0d, anti_30d, anti_6m, anti_12m, anti_18m, anti_24m,
         beta_0d, beta_30d, beta_6m, beta_12m, beta_18m, beta_24m,
         statin_0d, statin_30d, statin_6m, statin_12m, statin_18m, statin_24m) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("drug_type", "time"),
    names_pattern = "(.+)_(.+)"
  ) %>%
  mutate(
    value = as.numeric(value),  # 确保 value 列为数值型
    time = factor(time, levels = c("0d", "30d", "6m", "12m", "18m", "24m"))  # 自定义时间顺序
  )  # 确保 value 列为数值型

# 计算每个药物类别在各随访期的用药比例
proportion_df <- long_df %>%
  group_by(drug_type, time) %>%
  summarise(proportion = mean(value, na.rm = TRUE) * 100, .groups = "drop") %>%
  mutate(drug_type = case_when(
    drug_type == "anti" ~ "Anti-platelet",
    drug_type == "beta" ~ "Beta-blocker",
    drug_type == "statin" ~ "Statin",
    TRUE ~ drug_type
  ))

# 绘制优化后的直方图
ggplot(proportion_df, aes(x = time, y = proportion, fill = drug_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.8) +  # 设置柱宽和位置 去除条形边框
  scale_fill_manual(values = c("#2b8cbe", "#a6bddb", "#ece2f0")) +  # 简洁配色
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 20), expand = c(0, 0)) +
  labs(
    title = "Proportion of Medication Use by Follow-up Period",
    x = "Follow-up Period",
    y = "Proportion (%)",
    fill = "Medication Type"
  ) +
  theme_minimal(base_family = "Helvetica") +  # 简洁主题，使用无衬线字体
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),  # 标题居中，字体加粗
    axis.title = element_text(size = 12),  # 坐标轴标题字体大小
    axis.text = element_text(size = 10),  # 坐标轴标签字体大小
    legend.position = "top",  # 图例放在顶部
    legend.title = element_text(face = "bold"),  # 图例标题加粗
    panel.grid.major = element_blank(),  # 去除主要网格线
    panel.grid.minor = element_blank(),  # 去除次要网格线
    axis.line.x = element_line(color = "black", size = 0.5),  # 保留x轴线
    axis.ticks.x = element_line(color = "black", size = 0.5),  # 保留x轴刻度线
    axis.line.y = element_line(color = "black", size = 0.5),  # 保留y轴线
    axis.ticks.y = element_line(color = "black", size = 0.5)   # 保留y轴刻度线
  )
ggsave("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS4.pdf",width=30,height=20, units = "cm")
```
##1.1.3分年龄和性别的限制性立方样条图
```{r}
#根据这个限制性立方样条图得知可以将性别分为<=60,60-75,>=75
library(rms)
test <- matched_data1 %>%
    dplyr::select(age, death,sex) %>%
    mutate(across(death, as.numeric))

# 数据处理和绘图
plot_spline_by_sex <- function(data, sex_value, color, ylim_max, facet_label) {
  test <- data %>%
    filter(sex == sex_value) %>%
    dplyr::select(age, death) %>%
    mutate(across(death, as.numeric))
  
  dd <- datadist(test)
  options(datadist = 'dd')
  
  knots <- attr(rcspline.eval(test$age, nk = 4), "knots")
  
  fit1 <- lrm(death ~ rcs(age, 4), data = test)
  anova(fit1)
  
  OR1 <- Predict(fit1, age, fun = exp, ref.zero = TRUE)
  
  knot_yhat1 <- approx(OR1$age, OR1$yhat, xout = knots)$y
  
  knot_labels <- data.frame(age = knots, yhat = knot_yhat1)
  
  p <- ggplot() +
    geom_line(data = OR1, aes(x = age, y = yhat), linetype = 1, linewidth = 1, alpha = 0.9, color = color) +
    geom_ribbon(data = OR1, aes(x = age, ymin = lower, ymax = upper), alpha = 0.3, fill = color) +
    geom_hline(yintercept = 1, linetype = 2, linewidth = 0.8) +
    geom_vline(xintercept = 15, linetype = 2, size = 0.8) +
    geom_point(data = knot_labels, aes(x = age, y = yhat), color = color, size = 3) +
    geom_text(data = knot_labels, aes(x = age, y = yhat, label = sprintf("%.1f", age)), 
              vjust = -1, hjust = 1.5, color = color, size = 3.5) +
    labs(x = "Age at onset of AMI", y = "OR (95% CI)", title = facet_label) +
    scale_y_continuous(limits = c(0, ylim_max), breaks = seq(0, ylim_max, 1)) +
    scale_x_continuous(limits = c(30, 100), breaks = seq(30, 100, 10)) +
    theme_classic() +
    theme(
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10),
      plot.title = element_text(size = 10),
      axis.title = element_text(size = 15)
    )
  
  return(p)
}

p1 <- plot_spline_by_sex(test, 1, "blue", 18, 1)
p2 <- plot_spline_by_sex(test, 2, "red", 18, 2)

# 将两张图合并为一个 grob 对象
combined_plot <- grid.arrange(p1, p2, ncol = 2)

# 使用 ggsave 保存 grob 对象
ggsave("/Users/yilin/Documents/文章/早发心肌梗死/数据分析/结果/图/FigureS5.pdf", combined_plot, width = 10, height = 5)

```
#1.1.4/Figure S6-S9 分性别年龄组的生存曲线图，只分了年龄别没有分性别
```{r}
# 创建一个函数来绘制生存曲线
create_survival_plot <- function(data, agegrp_value,sex_value) {
  # 过滤数据
  data_subset <- data %>%
    filter(agegrp == agegrp_value&sex==sex_value)  # 使用数值进行过滤
  
  # 进行生存分析
  if (nrow(data_subset) == 0) {
    return(NULL)  # 如果没有观测值，则返回 NULL
  }
  
  surv_fit <- survfit(Surv(followupday, death) ~ case_control, data = data_subset, weights = weight)
  
  # 生存曲线绘制
  p <- ggsurvplot(surv_fit, data = data_subset,  conf.int = TRUE, 
                  palette = c("#2E9FDF", "#CA6F62"),
                  xlab = "Follow-up days", ylab = "Death(%)",
                  ggtheme = theme_bw(), 
                  fun = function(x) 100 * (1 - x),
                  legend = "none")  # 不显示图例
  
  # 添加标题
  agegrp_label <- case_when(
    agegrp_value == 1 ~ "<65 years",
    agegrp_value == 2 ~ "65-79 years",
    agegrp_value == 3 ~ ">=80 years"
  )
  sex_label<- case_when(
    sex_value == 1 ~ "Male",
    sex_value == 2 ~ "Female"
  )
  
title_text <- paste(sex_label, "  ", agegrp_label)  # 组合年龄组和性别标签
p$plot <- p$plot +
    scale_y_continuous(limits = c(0, 60)) +  # 设置 y 轴限制
    geom_vline(xintercept = 30, linetype = "dashed", color = "gray") + 
    geom_vline(xintercept = 90, linetype = "dashed", color = "gray") +
    ggtitle(title_text) +  # 将组合标签作为标题
    theme(plot.title = element_text(hjust = 0.5))  # 居中标题
  
  return(p$plot)
}


# 创建年龄组和性别的组合
agegrp_values <- c(1, 2, 3)  # 使用数值代表年龄组
sex_values<-c(1,2)

# 循环绘制每个组合的生存曲线，并存储结果
plot_list <- list()

for (sex_value in sex_values) {
  for (agegrp_value in agegrp_values) {
    plot <- create_survival_plot(matched_data1, agegrp_value, sex_value)
    if (!is.null(plot)) {
      plot_list[[paste("sex", sex_value, "agegrp", agegrp_value, sep = "_")]] <- plot
    }
  }
}

# 按照性别和年龄组的顺序排列 plot_list
plot_list_ordered <- plot_list[order(rep(sex_values, each = length(agegrp_values)), 
                                     rep(agegrp_values, times = length(sex_values)))]

# 导出为 PDF 文件
pdf("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS6.pdf", width = 12, height = 10)  # 设置文件名和页面大小
do.call(grid.arrange, c(plot_list, ncol = 3))  # 设置列数为3，行数会自动计算
dev.off()  # 关闭PDF设备

# 循环绘制每个组合的生存曲线，并存储结果
plot_list <- list()

for (sex_value in sex_values) {
  for (agegrp_value in agegrp_values) {
    plot <- create_survival_plot(matched_data2, agegrp_value, sex_value)
    if (!is.null(plot)) {
      plot_list[[paste("sex", sex_value, "agegrp", agegrp_value, sep = "_")]] <- plot
    }
  }
}

# 按照性别和年龄组的顺序排列 plot_list
plot_list_ordered <- plot_list[order(rep(sex_values, each = length(agegrp_values)), 
                                     rep(agegrp_values, times = length(sex_values)))]

# 导出为 PDF 文件
pdf("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS7.pdf", width = 12, height = 10)  # 设置文件名和页面大小
do.call(grid.arrange, c(plot_list, ncol = 3))  # 设置列数为3，行数会自动计算
dev.off()  # 关闭PDF设备
# 循环绘制每个组合的生存曲线，并存储结果
plot_list <- list()

for (sex_value in sex_values) {
  for (agegrp_value in agegrp_values) {
    plot <- create_survival_plot(matched_data3, agegrp_value, sex_value)
    if (!is.null(plot)) {
      plot_list[[paste("sex", sex_value, "agegrp", agegrp_value, sep = "_")]] <- plot
    }
  }
}

# 按照性别和年龄组的顺序排列 plot_list
plot_list_ordered <- plot_list[order(rep(sex_values, each = length(agegrp_values)), 
                                     rep(agegrp_values, times = length(sex_values)))]

# 导出为 PDF 文件
pdf("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS8.pdf", width = 12, height = 10)  # 设置文件名和页面大小
do.call(grid.arrange, c(plot_list, ncol = 3))  # 设置列数为3，行数会自动计算
dev.off()  # 关闭PDF设备
# 循环绘制每个组合的生存曲线，并存储结果
plot_list <- list()

for (sex_value in sex_values) {
  for (agegrp_value in agegrp_values) {
    plot <- create_survival_plot(matched_data4, agegrp_value, sex_value)
    if (!is.null(plot)) {
      plot_list[[paste("sex", sex_value, "agegrp", agegrp_value, sep = "_")]] <- plot
    }
  }
}

# 按照性别和年龄组的顺序排列 plot_list
plot_list_ordered <- plot_list[order(rep(sex_values, each = length(agegrp_values)), 
                                     rep(agegrp_values, times = length(sex_values)))]

# 导出为 PDF 文件
pdf("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS9.pdf", width = 12, height = 10)  # 设置文件名和页面大小
do.call(grid.arrange, c(plot_list, ncol = 3))  # 设置列数为3，行数会自动计算
dev.off()  # 关闭PDF设备
```
#1.2.1Table2率的计算
```{r}
library(parallel)
library(boot)

# Define function to calculate rate difference
rate_diff_func <- function(data, indices) {
  # Sample data based on indices
  sample_data <- data[indices, ]
  
  # Calculate rate difference between cases and controls
  rate_difference_bh <- weighted.mean(
    sample_data$death_lm[sample_data$case_control == 1], 
    sample_data$weight[sample_data$case_control == 1]
  ) - weighted.mean(
    sample_data$death_lm[sample_data$case_control == 0], 
    sample_data$weight[sample_data$case_control == 0]
  )
  
  return(rate_difference_bh)
}

# Calculate weighted mortality rates
calculate_weighted_mortality <- function(data) {
  # Calculate weighted mortality for case and control groups
  weighted_case_mortality <- weighted.mean(
    data$death_lm[data$case_control == 1], 
    data$weight[data$case_control == 1]
  )
  weighted_control_mortality <- weighted.mean(
    data$death_lm[data$case_control == 0], 
    data$weight[data$case_control == 0]
  )
  
  return(data.frame(
    weighted_case_mortality = weighted_case_mortality,
    weighted_control_mortality = weighted_control_mortality
  ))
}

# List of datasets
datasets <- list(
 LM1 = LM1, LM2 = LM2, LM3 = LM3, 
 LM_ppci1 = LM_ppci1, LM_ppci2 = LM_ppci2, LM_ppci3 = LM_ppci3, 
  LM_f1 = LM_f1, LM_f2 = LM_f2, LM_f3 = LM_f3, 
  LM_b1 = LM_b1, LM_b2 = LM_b2, LM_b3 = LM_b3
)

# Calculate weighted mortality rates and confidence intervals
results <- lapply(names(datasets), function(name) {
  data <- datasets[[name]]
  
  # Precompute mortality rates
  mortality <- calculate_weighted_mortality(data)
  mortality$dataset <- name
  
  # Perform bootstrap with default core settings
  bootstrap <- boot(
    data = data, 
    statistic = rate_diff_func, 
    R = 1000, # Adjust R for speed vs. accuracy
    parallel = "multicore"
  )
  
  # Calculate confidence intervals and handle cases where intervals cannot be computed
  ci_diff <- tryCatch({
    boot.ci(bootstrap, type = "perc")
  }, error = function(e) NULL)
  
  # Add rate difference and confidence intervals or NA if intervals cannot be calculated
  mortality$rate_difference <- mean(bootstrap$t)
  mortality$ci_diff_lower <- if (!is.null(ci_diff)) ci_diff$perc[4] else NA
  mortality$ci_diff_upper <- if (!is.null(ci_diff)) ci_diff$perc[5] else NA
  
  return(mortality)
})

# Combine results into a single dataset
final_results <- do.call(rbind, results)
final_results


export_to_excel(final_results, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/Table2.xlsx", "weight")


create_table_one <- function(data,datasets_name){
  tableOne <- CreateTableOne(vars ="death_lm", factorVars ="death_lm",strata = c("case_control"),data =data, includeNA = F,addOverall=T)
tab <- as.data.frame(print(tableOne,showAllLevels = F, quote = FALSE, noSpaces = TRUE, missing = TRUE,contDigits = 1))
tab$dataset<-datasets_name
return(tab)
}
all_table<-lapply(names(datasets),function(name){create_table_one(datasets[[name]],name)})
final_table<-do.call(rbind,all_table)


export_to_excel(final_table, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS5.xlsx", "Sheet2")
```
#1.2.2Table2/Table S2/Cox 回归
```{r}
#灵活参数模型
library(rstpm2)
# 定义一个函数来提取HR、置信区间和p值0.010747
extract_hr_p <- function(model, model_name) {
  # 提取模型的summary
  model_summary <- summary(model)
  
  # 提取case_control的系数、标准误和p值
  coef_value <- coef(model_summary)["case_control", "Estimate"]
  se_value <- coef(model_summary)["case_control", "Std. Error"]
  p_value <- coef(model_summary)["case_control", "Pr(z)"]
  
  # 计算HR和置信区间
  HR <- exp(coef_value)
  HR_lower <- exp(coef_value - 1.96 * se_value)
  HR_upper <- exp(coef_value + 1.96 * se_value)
  
  # 创建一个数据框返回结果
  result <- data.frame(
    model_name = model_name,
    HR = HR,
    HR_lower = HR_lower,
    HR_upper = HR_upper,
    p = p_value
  )
  
  return(result)
}


#ppci
# 0-30天
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =3, 
                    data = LM_ppci1)
AIC(model_0_30)
summary(model_0_30)


# 30-90天
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =3, 
                     data = LM_ppci2)
summary(model_30_90)
# 90-365天
model_90_1y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =3, 
                     data = LM_ppci3_1)
summary(model_90_1y)
# 365-5y天
model_1y_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =3, 
                     data = LM_ppci3_2)

summary(model_1y_5y)

# 90天-5年
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, 
                     data = LM_ppci3)
AIC(model_90_5y)
summary(model_90_5y)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 合并两个结果为一个数据框
results_df <- rbind(result_0_30,result_30_90, result_90_5y)

# 查看合并后的数据框
print(results_df)
export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/Table2.xlsx", "ppci")

#溶栓治疗
# 0-30天
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control, df =3,data = LM_f1)
AIC(model_0_30)
summary(model_0_30)
# 30-90天
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control, df =5, data = LM_f2)
AIC(model_30_90)
summary(model_30_90)
# 90天-5年，所有病例都能匹配上10个对照
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control, df =5,data = LM_f3)
AIC(model_90_5y)
summary(model_90_5y)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 合并两个结果为一个数据框
results_df1 <- rbind(result_0_30,result_30_90, result_90_5y)

# 查看合并后的数据框
print(results_df1)
export_to_excel(results_df1, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/Table2.xlsx", "fibri")

#保守治疗
# 0-30天
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =3,data = LM_b1)
AIC(model_0_30)
summary(model_0_30)
# 30-90天
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, data = LM_b2)
AIC(model_30_90)
summary(model_30_90)
# 90天-5年
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =4,data = LM_b3)
AIC(model_90_5y)
summary(model_90_5y)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 合并两个结果为一个数据框
results_df2 <- rbind(result_0_30,result_30_90, result_90_5y)

# 查看合并后的数据框
print(results_df2)
export_to_excel(results_df2, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/Table2.xlsx", "baoshou")

#全人群

model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =4, 
                    data = LM1)
AIC(model_0_30)
summary(model_0_30 )
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, 
                     data = LM2)
AIC(model_30_90 )
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, 
                     data = LM3)
AIC(model_90_5y)
summary(model_90_5y)
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 合并两个结果为一个数据框
results_df <- rbind(result_0_30,result_30_90, result_90_5y)

# 查看合并后的数据框
print(results_df)
export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/Table2.xlsx", "all")



```
#1.2.3 TableS7 Adding age and corvarites into models
```{r}
covariates <- c("diabetes", "hyp", "edu", "smoke")
#ppci
# 0-30天
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =3,data = LM_ppci1)
# 30-90天
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =3, data = LM_ppci2)
# 90天-5年
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =5, data = LM_ppci3)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")
#ppci
# 0-30天
model_0_30 <- LM_ppci1 %>%
  filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>% stpm2(Surv(FUds, death_lm) ~case_control+age+diabetes+hyp+edu+smoke+cluster(matchid_size), df =3, data = .)
# 30-90天
model_30_90 <- LM_ppci2%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =3, data =. )
# 90天-5年
model_90_5y <- LM_ppci3%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =5, data = .)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30a <- extract_hr_p(model_0_30, "model_0_30")
result_30_90a <- extract_hr_p(model_30_90, "model_30_90")
result_90_5ya <- extract_hr_p(model_90_5y, "model_90_5y")
# 合并两个结果为一个数据框
results_df <- rbind(result_0_30,result_30_90, result_90_5y,result_0_30a,result_30_90a, result_90_5ya)

export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS7.xlsx", "ppci")

#溶栓治疗
# 0-30天
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+age, df =3,data = LM_f1)
# 30-90天
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+age, df =5, data = LM_f2)
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+age, df =5,data = LM_f3)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 0-30天
model_0_30 <- LM_f1%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke, df =3,data =. )
# 30-90天
model_30_90 <- LM_f2%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke, df =3, data = .)
# 90天-5年
model_90_5y <- LM_f3%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke, df =5,data = .)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30a <- extract_hr_p(model_0_30, "model_0_30")
result_30_90a <- extract_hr_p(model_30_90, "model_30_90")
result_90_5ya <- extract_hr_p(model_90_5y, "model_90_5y")
# 合并两个结果为一个数据框
results_df1 <- rbind(result_0_30,result_30_90, result_90_5y,result_0_30a,result_30_90a, result_90_5ya)
export_to_excel(results_df1, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS7.xlsx", "fibri")

#保守治疗
# 0-30天
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =3,data = LM_b1)
# 30-90天
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =5, data = LM_b2)
# 90天-5年
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =4,data = LM_b3)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 0-30天
model_0_30 <- LM_b1%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =3,data =.)

# 30-90天
model_30_90 <- LM_b2%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =5, data =.)
# 90天-5年
model_90_5y <- LM_b3%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =4,data =.)
# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30a <- extract_hr_p(model_0_30, "model_0_30")
result_30_90a <- extract_hr_p(model_30_90, "model_30_90")
result_90_5ya <- extract_hr_p(model_90_5y, "model_90_5y")
# 合并两个结果为一个数据框
results_df2 <- rbind(result_0_30,result_30_90, result_90_5y,result_0_30a,result_30_90a, result_90_5ya)

export_to_excel(results_df2, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS7.xlsx", "baoshou")

#全人群
model_0_30 <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =4, data = LM1)
model_30_90 <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =5, data = LM2)
model_90_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+age+ cluster(matchid_size), df =5, data = LM3)

result_0_30 <- extract_hr_p(model_0_30, "model_0_30")
result_30_90 <- extract_hr_p(model_30_90, "model_30_90")
result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

model_0_30 <- LM1%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =4, data =.)
model_30_90 <- LM2%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =5, data =.)

model_90_5y <- LM3%>% filter(!(diabetes=="")&!(hyp=="")&!(edu=="")&!(smoke=="")) %>%stpm2(Surv(FUds, death_lm) ~ case_control+age+diabetes+hyp+edu+smoke+ cluster(matchid_size), df =5, data =.)

result_0_30a <- extract_hr_p(model_0_30, "model_0_30")
result_30_90a <- extract_hr_p(model_30_90, "model_30_90")
result_90_5ya <- extract_hr_p(model_90_5y, "model_90_5y")
# 合并两个结果为一个数据框
results_df <- rbind(result_0_30,result_30_90, result_90_5y,result_0_30a,result_30_90a, result_90_5ya)

export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS7.xlsx", "all")
```
##1.2.1.1条件逻辑回归
```{r}
# 定义一个函数来提取HR、置信区间和p值0.010747
extract_clo_hr_p <- function(model, model_name) {
  # 提取模型的summary
  model_summary <- summary(model)
  
  # 提取case_control的系数、标准误和p值
  HR <- model_summary[["conf.int"]]["case_control", "exp(coef)"]
  HR_lower <- model_summary[["conf.int"]]["case_control", "lower .95"]
  HR_upper <- model_summary[["conf.int"]]["case_control", "upper .95"]
    p_value <- model_summary[["coefficients"]]["case_control", "Pr(>|z|)"]
  # 创建一个数据框返回结果
  result <- data.frame(
    model_name = model_name,
    HR = HR,
    HR_lower = HR_lower,
    HR_upper = HR_upper,
    p = p_value
  )
  
  return(result)
}
#TableS2,条件罗辑回归
model_clogit <- clogit(death_lm ~ case_control + strata(matchid), weights=weight,data = LM1,method = "efron")
result_0_30<-extract_clo_hr_p(model_clogit, "model_0_30")
model_clogit <- clogit(death_lm ~ case_control + strata(matchid), data = LM2,weights=weight,method = "efron")
result_30_90<-extract_clo_hr_p(model_clogit, "model_30_90")
model_clogit <- clogit(death_lm ~ case_control + strata(matchid), data = LM3,weights=weight,method = "efron")
result_90_5y<-extract_clo_hr_p(model_clogit, "model_90_5y")
# 合并两个结果为一个数据框
results_df <- rbind(result_0_30,result_30_90, result_90_5y)

# 查看合并后的数据框
print(results_df)
export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS3.xlsx", "Sheet2")
model_clogit <- clogit(death_lm ~ case_control + strata(matchid), weights=weight,data = LM_ppci1,method = "efron")
result_0_30<-extract_clo_hr_p(model_clogit, "model_0_30")
model_clogit <- clogit(death_lm ~ case_control + strata(matchid), weights=weight,data = LM_ppci2,method = "efron")
result_30_90<-extract_clo_hr_p(model_clogit, "model_30_90")
model_clogit <- clogit(death_lm ~ case_control + strata(matchid), weights=weight,data = LM_ppci3,method = "efron")
result_90_5y<-extract_clo_hr_p(model_clogit, "model_90_5y")
# 合并两个结果为一个数据框
results_df <- rbind(result_0_30,result_30_90, result_90_5y)

# 查看合并后的数据框
print(results_df)
export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS3.xlsx", "Sheet3")


```
##1.1.1累计死亡率图
```{r}
test<-cami5y %>% filter(age>=75)
# 创建生存对象
surv_obj <- Surv(test$followupyear,test$death)

# 拟合Cox模型
fit <- coxph(surv_obj ~ 1, data = test)
hazard <- basehaz(fit, centered = FALSE)


# 绘制累积危险曲线
ggplot(hazard, aes(x = time, y = hazard)) +
  geom_line() +
  labs(x = "随访时间", y = "累计危险 (Nelson-Aalen 估计)") +
  theme_minimal()

# 计算每个时间点的瞬时死亡率
hazard$death_rate_per_1000 <- diff(c(0, hazard$hazard)) / diff(c(0, hazard$time)) * 1000

# 去除第一个空行（因为无法计算第一个时间点的变化率）
hazard <- hazard[-1, ]

# 绘制瞬时死亡率的变化曲线
ggplot(hazard, aes(x = time, y = death_rate_per_1000)) +
  geom_line() +
  labs(x = "随访时间", y = "每1000人年的瞬时死亡率") +
  theme_minimal()


```
#1.2.4  溶栓患者中补救PCI
```{r}
#溶栓治疗
# 0-30天
# 第一步：获取需要保留的matchid集合
selected_matchids <- LM_f1 %>% 
  filter(res_fibri == 1) %>%  # 筛选目标病例
  distinct(matchid) %>%       # 提取唯一matchid
  pull(matchid)               # 转换为向量

 
model_0_30 <-  LM_f1 %>%
  filter(matchid %in% selected_matchids) %>% stpm2(Surv(FUds, death_lm) ~ case_control, df =3,data =.)

# 90天-5年
# 第一步：获取需要保留的matchid集合
selected_matchids <- LM_f3 %>% 
  filter(res_fibri == 1) %>%  # 筛选目标病例
  distinct(matchid) %>%       # 提取唯一matchid
  pull(matchid)               # 转换为向量

model_90_5y <- LM_f3%>%
  filter(matchid %in% selected_matchids)  %>%stpm2(Surv(FUds, death_lm) ~ case_control, df =5,data =.)

# 使用该函数分别提取 30-90 天和 90天-5年模型的结果
result_0_30 <- extract_hr_p(model_0_30, "model_0_30")

result_90_5y <- extract_hr_p(model_90_5y, "model_90_5y")

# 合并两个结果为一个数据框
results_df1 <- rbind(result_0_30, result_90_5y)

# 查看合并后的数据框
print(results_df1)
export_to_excel(results_df1, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS8.xlsx", "fibri")
```

#1.2.5 TableS8 stemi分年龄别性别的死亡率和HR，90天幸存者
```{r}

# 定义运行 stpm 分析的函数
run_stpm_analysis <- function(data, prefix, data_source, df_value) {
  # 定义性别和年龄组组合
  sex_age_groups <- list(
    list(sex = 1, agegrp = 1, label = paste0(prefix, "_male_agegrp1")),
    list(sex = 1, agegrp = 2, label = paste0(prefix, "_male_agegrp2")),
    list(sex = 1, agegrp = 3, label = paste0(prefix, "_male_agegrp3")),
    list(sex = 2, agegrp = 1, label = paste0(prefix, "_female_agegrp1")),
    list(sex = 2, agegrp = 2, label = paste0(prefix, "_female_agegrp2")),
    list(sex = 2, agegrp = 3, label = paste0(prefix, "_female_agegrp3"))
  )
  # 存储每个模型结果的列表
  results <- lapply(sex_age_groups, function(group) {
    # 根据性别和年龄组进行过滤
    test <- data %>% filter(sex == group$sex & agegrp == group$agegrp)
    # 拟合条件逻辑回归模型，使用传入的 df 值
    model_stpm <- stpm2(Surv(FUds, death_lm) ~ case_control,robust=TRUE, df = df_value, data = test)
    #+cluster(matchid_size)
    # 提取 HR 和 p 值，添加标签
    result <- extract_hr_p(model_stpm, group$label)
    # 添加数据源列
    result$data_source <- data_source
    return(result)
  })
  # 将所有结果合并为一个数据框
  results_df <- do.call(rbind, results)
  return(results_df)
}

# 使用函数运行分析并合并结果，设置不同的 df 值
#results_df1 <- run_stpm_analysis(LM1, "result_0_30", "LM1", df_value = 4)
#results_df2 <- run_stpm_analysis(LM2, "result_30_90", "LM2", df_value = 5)
results_df1 <- run_stpm_analysis(LM3, "result_90_5y", "LM3", df_value = 5)
# 合并所有结果
#final_results <- bind_rows(results_df1, results_df2, results_df3)

# 使用函数运行分析并合并结果，设置不同的 df 值
#results_df1 <- run_stpm_analysis(LM_b1, "result_0_30", "LM_b1", df_value = 3)
#results_df2 <- run_stpm_analysis(LM_b2, "result_30_90", "LM_b2", df_value = 3)
results_df2 <- run_stpm_analysis(LM_b3, "result_90_5y", "LM_b3", df_value = 4)
# 合并所有结果
results_df3 <- run_stpm_analysis(LM_b3, "result_90_5y", "LM_f3", df_value = 5)
results_df4 <- run_stpm_analysis(LM_ppci3, "result_90_5y", "LM_ppci3", df_value = 5)
final_results <- bind_rows(results_df1, results_df2, results_df3, results_df4)
export_to_excel(final_results, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS9.xlsx", "final_HR")




# 改成两个年龄组
run_stpm_analysis2 <- function(data, prefix, data_source, df_value) {
  sex_age_groups <- list(
    list(sex = 1, agegrp = 1, label = paste0(prefix, "_male_agegrp1")),
    list(sex = 1, agegrp = 2, label = paste0(prefix, "_male_agegrp2")),
    list(sex = 2, agegrp = 1, label = paste0(prefix, "_female_agegrp1")),
    list(sex = 2, agegrp = 2, label = paste0(prefix, "_female_agegrp2"))
  )
  results <- lapply(sex_age_groups, function(group) {
    test <- data %>% filter(sex == group$sex & agegrp == group$agegrp)
    model_stpm <- stpm2(Surv(FUds, death_lm) ~ case_control,robust=TRUE,df = df_value, data = test)
    result <- extract_hr_p(model_stpm, group$label)
    result$data_source <- data_source
    return(result)
  })
  results_df <- do.call(rbind, results)
  return(results_df)
}
#溶栓部分由于数量较少，将0-90天合并，年龄只分是否大于65
data_age_recate <- function(data){
    data %>% mutate(agegrp = case_when(
        age < 65 ~ 1,
        age >= 65 ~ 2
    ))
}


# 使用函数运行分析并合并结果，设置不同的 df 值
results_df1 <-LM_f4 %>%data_age_recate() %>% run_stpm_analysis2(., "result_0_90", "LM_f4", df_value = 3)
results_df2 <- LM_f3 %>%data_age_recate() %>%  run_stpm_analysis2(., "result_90_5y", "LM_f3", df_value = 5)
final_results3 <- bind_rows(results_df1, results_df2)

# 使用函数运行分析并合并结果，设置不同的 df 值
results_df1 <- LM_ppci4 %>%data_age_recate() %>% run_stpm_analysis2(., "result_0_90", "LM_ppci4", df_value = 3)
results_df2 <- LM_ppci3 %>%data_age_recate() %>% run_stpm_analysis2(., "result_90_5y", "LM_ppci3", df_value = 5)
# 合并所有结果
final_results4 <- bind_rows(results_df1, results_df2)
final_HR<-rbind(final_results,final_results2,final_results3,final_results4)
# 导出到 Excel
#export_to_excel(final_HR, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS9.xlsx", "final_HR")




# 定义函数以生成死亡情况表
create_mortality_table <- function(data, prefix) {
  # 定义年龄组和性别组合
  sex_age_groups <- list(
    list(sex = 1, agegrp = 1, label = paste0(prefix, "_male_agegrp1")),
    list(sex = 1, agegrp = 2, label = paste0(prefix, "_male_agegrp2")),
    list(sex = 1, agegrp = 3, label = paste0(prefix, "_male_agegrp3")),
    list(sex = 2, agegrp = 1, label = paste0(prefix, "_female_agegrp1")),
    list(sex = 2, agegrp = 2, label = paste0(prefix, "_female_agegrp2")),
    list(sex = 2, agegrp = 3, label = paste0(prefix, "_female_agegrp3"))
  )
  
  # 创建并存储分组结果
  tables <- lapply(sex_age_groups, function(group) {
    # 筛选分组数据
    group_data <- data %>% filter(sex == group$sex, agegrp == group$agegrp)
    
    # 生成死亡情况的表
    table <- CreateTableOne(vars = "death_lm", factorVars = "death_lm", 
                            strata = "case_control", data = group_data, 
                            includeNA = FALSE, addOverall = TRUE)
    
    # 将表格转化为数据框
    tab_df <- as.data.frame(print(table, showAllLevels = FALSE, quote = FALSE, 
                                  noSpaces = TRUE, missing = TRUE, contDigits = 1))
    tab_df$Group <- group$label  # 添加分组标记
    return(tab_df)
  })
  
  # 合并所有表格
  combined_table <- bind_rows(tables)
  return(combined_table)
}

# 定义函数以生成死亡情况表
create_mortality_table2 <- function(data, prefix) {
  # 定义年龄组和性别组合
  sex_age_groups <- list(
    list(sex = 1, agegrp = 1, label = paste0(prefix, "_male_agegrp1")),
    list(sex = 1, agegrp = 2, label = paste0(prefix, "_male_agegrp2")),
    list(sex = 2, agegrp = 1, label = paste0(prefix, "_female_agegrp1")),
    list(sex = 2, agegrp = 2, label = paste0(prefix, "_female_agegrp2"))
  )
  tables <- lapply(sex_age_groups, function(group) {
    group_data <- data %>% filter(sex == group$sex, agegrp == group$agegrp)
    table <- CreateTableOne(vars = "death_lm", factorVars = "death_lm", 
                            strata = "case_control", data = group_data, 
                            includeNA = FALSE, addOverall = TRUE)
    tab_df <- as.data.frame(print(table, showAllLevels = FALSE, quote = FALSE, 
                                  noSpaces = TRUE, missing = TRUE, contDigits = 1))
    tab_df$Group <- group$label  # 添加分组标记
    return(tab_df)
  })

  combined_table <- bind_rows(tables)
  return(combined_table)
}
# 使用函数运行分析并合并结果

tab_LM3 <- create_mortality_table(LM3, "LM3")
tab_LM_b3 <- create_mortality_table(LM_b3, "LM_b3")
tab_LM_f3 <- create_mortality_table(LM_f3, "LM_b3")
tab_LM_p3 <- create_mortality_table(LM_ppci3, "LM_ppci3")



final_mortality<-rbind(tab_LM3,tab_LM_b3,tab_LM_f3,tab_LM_p3)
# 导出到 Excel
export_to_excel(final_mortality, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS9.xlsx", "final_mortality")


# 定义计算加权死亡率差异的函数，并增加数据来源列
calculate_weighted_mortality_rate_difference <- function(data, source_label) {
  # 创建一个数据框来存储结果
  results <- data.frame(sex = integer(),
                        agegrp = integer(),
                        weighted_case_mortality = numeric(),
                        weighted_control_mortality = numeric(),
                        rate_difference = numeric(),
                        source = character(),
                        stringsAsFactors = FALSE)
  
  # 遍历性别和年龄组的组合
  for (sex in unique(data$sex)) {
    for (age_group in unique(data$agegrp)) {
      # 过滤数据
      subset_data <- data[data$sex == sex & data$agegrp == age_group, ]
      # 计算病例组的加权死亡率
      weighted_case_mortality <- weighted.mean(subset_data$death_lm[subset_data$case_control == 1], subset_data$weight[subset_data$case_control == 1], na.rm = TRUE)
      # 计算对照组的加权死亡率
      weighted_control_mortality <- weighted.mean(subset_data$death_lm[subset_data$case_control == 0], subset_data$weight[subset_data$case_control == 0], na.rm = TRUE)
      # 计算死亡率差异
      rate_difference <- weighted_case_mortality - weighted_control_mortality
      # 将结果添加到数据框中
      results <- rbind(results, data.frame(
        sex = sex,
        agegrp = age_group,
        weighted_case_mortality = weighted_case_mortality,
        weighted_control_mortality = weighted_control_mortality,
        rate_difference = rate_difference,
        source = source_label))
    }
  }
  
  return(results)
}


results_df1 <- LM3 %>% calculate_weighted_mortality_rate_difference(., "LM3")
results_df2 <- LM_b3 %>% calculate_weighted_mortality_rate_difference(., "LM_b3")
results_df3 <- LM_f3 %>% calculate_weighted_mortality_rate_difference(., "LM_f3")
results_df4 <- LM_ppci3 %>% calculate_weighted_mortality_rate_difference(., "LM_ppci3")
results2 <- rbind(results_df1, results_df2, results_df3, results_df4)


# 导出到 Excel
export_to_excel(results2 , "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS9.xlsx", "final_rate")

```
#1.2.6 TableS6 taking 1 year as landmark
```{r}
#全人群
# 0-1y
model_0_1y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, 
                     data = LM_3_1)
# 365-5y天
model_1y_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, 
                     data = LM_3_2)
AIC(model_1y_5y)
result_0_1y <- extract_hr_p(model_0_1y, "model_0_1y")
result_1y_5y <- extract_hr_p(model_1y_5y, "model_1y_5y")
results_df <- rbind(result_0_1y,result_1y_5y)
export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS6.xlsx", "all")
#ppci
# 0-1y
model_0_1y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =3, 
                     data = LM_ppci3_1)

# 365-5y天
model_1y_5y <- stpm2(Surv(FUds, death_lm) ~ case_control+ cluster(matchid_size), df =5, 
                     data = LM_ppci3_2)
result_0_1y <- extract_hr_p(model_0_1y, "model_0_1y")
result_1y_5y <- extract_hr_p(model_1y_5y, "model_1y_5y")
results_df <- rbind(result_0_1y,result_1y_5y)
export_to_excel(results_df, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS6.xlsx", "ppci")

#溶栓治疗
# 0-1y
model_0_1y <- stpm2(Surv(FUds, death_lm) ~ case_control, df =5, data = LM_f3_1)
# 365-5y天
model_1y_5y <- stpm2(Surv(FUds, death_lm) ~ case_control, df =5, data = LM_f3_2)
result_0_1y <- extract_hr_p(model_0_1y, "model_0_1y")
result_1y_5y <- extract_hr_p(model_1y_5y, "model_1y_5y")
results_df1 <- rbind(result_0_1y,result_1y_5y)
export_to_excel(results_df1, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS6.xlsx", "fibri")

#保守治疗
# 0-1y
model_0_1y <- stpm2(Surv(FUds, death_lm) ~ case_control, df =5, data = LM_b3_1)
# 365-5y天
model_1y_5y <- stpm2(Surv(FUds, death_lm) ~ case_control, df =5, data = LM_b3_2)
result_0_1y <- extract_hr_p(model_0_1y, "model_0_1y")
result_1y_5y <- extract_hr_p(model_1y_5y, "model_1y_5y")
results_df3 <- rbind(result_0_1y,result_1y_5y)
export_to_excel(results_df3, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS6.xlsx", "baoshou")

# List of datasets
datasets <- list(
  LM_3_1 = LM_3_1, LM_3_2 = LM_3_2, 
  LM_ppci3_1 = LM_ppci3_1, LM_ppci3_2 = LM_ppci3_2, 
  LM_f3_1 = LM_f3_1, LM_f3_2 = LM_f3_2, 
  LM_b3_1 = LM_b3_1, LM_b3_2 = LM_b3_2
)
# Calculate weighted mortality rates and confidence intervals
results <- lapply(names(datasets), function(name) {
  data <- datasets[[name]]
  
  # Precompute mortality rates
  mortality <- calculate_weighted_mortality(data)
  mortality$dataset <- name
  
  # Perform bootstrap with default core settings
  bootstrap <- boot(
    data = data, 
    statistic = rate_diff_func, 
    R = 1000, # Adjust R for speed vs. accuracy
    parallel = "multicore"
  )
  
  # Calculate confidence intervals and handle cases where intervals cannot be computed
  ci_diff <- tryCatch({
    boot.ci(bootstrap, type = "perc")
  }, error = function(e) NULL)
  
  # Add rate difference and confidence intervals or NA if intervals cannot be calculated
  mortality$rate_difference <- mean(bootstrap$t)
  mortality$ci_diff_lower <- if (!is.null(ci_diff)) ci_diff$perc[4] else NA
  mortality$ci_diff_upper <- if (!is.null(ci_diff)) ci_diff$perc[5] else NA
  
  return(mortality)
})

# Combine results into a single dataset
final_results <- do.call(rbind, results)
final_results



export_to_excel(final_results, "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/表/TableS6.xlsx", "weight")

```

#1.3亚组分析Figure2
```{r}
generate_summary_table <- function(data) {
  # 初始化汇总表
  summary_table <- data.table(
    Group = character(),
    STEMI_Mortality = character(),
    GP_Mortality = character(),
    RD = character(),
    HR = character(),
    HRvalue=numeric(),
    HR_lower=numeric(),
    HR_upper=numeric()
  )
  data1<-data %>% filter(case_control==1)  
  # 定义分组
  groups <- list(
    "Overall" = data1,
    "Men" = data1[sex ==1],
    "Women" = data1[sex ==2],
    "Age <65 years" = data1[age < 65],
    "Age >=65 years" = data1[age >= 65],
    "Primary or below" = data1[edu == 1],
    "Secondary" = data1[edu == 2],
    "College or above" = data1[edu == 3],
    "Diabetes" = data1[diabetes == 1],
    "No diabetes" = data1[diabetes == 0],
    "Hypertension" = data1[hyp == 1],
    "No hypertension" = data1[hyp == 0],
    "Hypercholesterolemia" = data1[gxz == 1],
    "No Hypercholesterolemia" = data1[gxz == 0],
    "Current smoking" = data1[smoke == 1],
    "Never or former smoker" = data1[smoke == 0],
    "Symptom onset to hospital time <12h" = data1[time_12h_admi == 1],
    "Symptom onset to hospital time >=12h" = data1[time_12h_admi == 0],
    "LVEF <40%" = data1[LVEF40 == 1],
    "LVEF >=40%" = data1[LVEF40 == 0]
  )
  
  # 遍历每个分组
  for (name in names(groups)) {
    group_data <- groups[[name]]
    
    # 从 cami5y 数据中获取对应的 matchid
    matchides <- unique(group_data$matchid)
    
    # 提取 cami5y 数据集的所有匹配 matchid 的观测
    matched_data <- data[data$matchid %in% matchides]
    
    
    # 计算死亡率
    mortality <- calculate_weighted_mortality(matched_data)

    # 使用 Bootstrapping 计算率差异
    bootstrap <- boot(data = matched_data, statistic = rate_diff_func, R = 1000)
    
    # 计算率差异和置信区间
    ci_diff <- boot.ci(bootstrap, type = "norm")
    
    rd <- sprintf("%.2f", mean(bootstrap$t)*100)
   # 对 bootstrap$t 排序并计算 2.5% 和 97.5% 分位数作为置信区间
rd_ci_lower <- quantile(bootstrap$t, 0.025) * 100
rd_ci_upper <- quantile(bootstrap$t, 0.975) * 100

# 将 Rate Difference 和置信区间合并
rd_ci <- paste0(sprintf("%.2f", rd_ci_lower), "-", sprintf("%.2f", rd_ci_upper))
    
    # 使用灵活参数模型计算 HR
    cox_model <- stpm2(Surv(FUds, death_lm) ~ case_control, df = 5, data = matched_data)
    model_summary<-summary(cox_model)
    # 提取系数和标准误
    coef_value <- coef(model_summary)["case_control", "Estimate"]
    se_value <- coef(model_summary)["case_control", "Std. Error"]
    
    # 计算 HR 及其置信区间
    HR <- exp(coef_value)
    HR_lower <- exp(coef_value - 1.96 * se_value)
    HR_upper <- exp(coef_value + 1.96 * se_value)
    hr_str <- paste0(sprintf("%.2f", HR), " (", sprintf("%.2f", HR_lower), "-", sprintf("%.2f", HR_upper), ")")
    # 将结果添加到汇总表
    summary_table <- rbind(summary_table, data.table(
      Group = name,
      STEMI_Mortality = sprintf("%.2f", mortality$weighted_case_mortality * 100),
      GP_Mortality = sprintf("%.2f", mortality$weighted_control_mortality * 100),
      RD = paste0(rd, " (", rd_ci, ")"),
      HR = hr_str,
      HRvalue=HR,
      HR_lower=HR_lower,
      HR_upper=HR_upper
    ))
  }
  
  return(summary_table)
}
# 全人群
sele<-function(data){
  data %>% dplyr::select(LVEF40,sex,time_12h_admi,smoke, gxz, hyp, diabetes, edu, age, FUds, death_lm, case_control, weight, matchid, matchid_size) %>% 
    as.data.table(.)
}
#第一个要加上cluster(match_size)
summary_table <- LM3 %>%sele(.) %>%  generate_summary_table(.)
summary_table1 <- LM_ppci3  %>%sele(.) %>%  generate_summary_table(.)               summary_table2 <- LM_f3%>%sele(.) %>% generate_summary_table(.)                     summary_table3 <- LM_b3%>%sele(.) %>% generate_summary_table(.)                                                                                                                                                                                                                                                                                                                  
```
##1.3.1Figur2 FigureS3-S5森林图
```{r}
# 定义分组顺序
group_order <- c(
  "Overall", "Men", "Women", "Age <65 years", "Age >=65 years",
  "Primary or below", "Secondary", "College or above",
  "Diabetes", "No diabetes", "Hypertension", "No hypertension",
  "Hypercholesterolemia", "No Hypercholesterolemia", 
  "Current smoking", "Never or former smoker",
  "Symptom onset to hospital time <12h", "Symptom onset to hospital time >=12h",
  "LVEF <40%", "LVEF >=40%"
)

create_forest_plot <- function(data, xticks, x,output_path,wid) {
  
  # 创建森林图数据
  forest_data <- data %>%
    mutate(
      Group = factor(Group, levels = group_order),
      grp = c(1, 2, 3, 2, 3, 2, 3, 3, 2, 3, 2, 3, 2, 3, 2, 3, 2, 3, 2, 3)  # 定义 grp（根据需要调整）
    )
  
  # 为不同的 grp 分配颜色（确保颜色数与 grp 的种类相同）
  group_colors <- c("#1F77B4", "#FF7F0E", "#2CA02C") 
  forest_data$group_color <- group_colors[forest_data$grp]
  # 使用 fp_set_style 来为每个 grp 设置不同的颜色
  # 为每行分配颜色而不是仅为组分配颜色
  box_colors <- c("",forest_data$group_color)  # 为每行分配颜色

  # 创建森林图
  p <- forestplot(forest_data[, c(1:5)], 
                  mean = forest_data$HRvalue,
                  lower = forest_data$HR_lower,
                  upper = forest_data$HR_upper,
                  clip = c(0, max(xticks)),
                  xticks = xticks,
                  ci.vertices = TRUE,
                  ci.vertices.height = 0.05,
                  zero = 1,  # Reference line at HR=1
                  lwd.zero = 1.5,  # Bold zero line
                  lwd.ci = 2,  # Bold confidence interval lines
                  boxsize = .5,
                  col = fpColors(box = "darkblue", line = "black", summary = "darkblue"),
                  xlab = "Hazard Ratio (HR)",  # X-axis label
                  ci.anchor = 1,  # Position confidence interval at the HR=1 line
                  txt_gp = fpTxtGp(
                    ticks = gpar(fontfamily = "sans", cex = 1.4, lineheight = 1.2),
                    label = gpar(cex = 1.5, fontface = "bold"),
                    summary = gpar(cex = 1.8, fontface = "bold"),
                    xlab = gpar(cex = 2)
                  ))
  

  
  p <- p |>
    fp_add_lines(h_2 = gpar(lty = 2))|>
    fp_set_style(box = lapply(box_colors, function(x) gpar(fill = x, col = "#555555")),  # 每个箱体分配颜色
                 default = gpar(vertices = TRUE)
    ) |>fp_add_header(Group = c(""),
                 STEMI_Mortality = x,
                 GP_Mortality = c("GP Mortality(%)"),
                RD = c("RD (%,95%CI)"),
                HR = c("HR (95%CI)")) 
  
  # 打印和保存图形
  grid.newpage()
  print(p, newpage = FALSE)
  
  grabbed_plot <- grid.grab()
  
  # 保存为PDF
  ggsave(output_path, plot = grabbed_plot, width = wid, height = 30, units = "cm")
}

# 示例：对多个数据集生成森林图，使用相同的group_order和group_colors
create_forest_plot(data=summary_table, xticks=seq(0, 4, 0.5),x="STEMI Mortality(%)",
                   output_path = "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/Figure2.pdf",wid=55)
# 示例：对多个数据集生成森林图，使用相同的group_order和group_colors
create_forest_plot(data=summary_table1, xticks=seq(0, 4, 0.5),x="PPCI Mortality(%)",
                   output_path = "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS3.pdf",wid=55)
# 示例：对多个数据集生成森林图，使用相同的group_order和group_colors
create_forest_plot(data=summary_table2, xticks=seq(0, 6.5, 0.5),x="Fibrinolysis Mortality(%)",output_path = "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS4.pdf",wid=60)
# 示例：对多个数据集生成森林图，使用相同的group_order和group_colors
create_forest_plot(data=summary_table3, xticks=seq(0, 4.5, 0.5),x="No Reperfusion Mortality(%)",output_path = "/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/FigureS5.pdf",wid=60)
```
#1.4.1保守治疗的原因
```{r}
category_translation <- c(
  "ST-segment resolved", "Other", "Transfer planned", 
  "Family declined (risk concern)", "Missed reperfusion window", 
  "Declined (financial issue)", "Critical condition", 
  "Contraindicated", "GI bleeding history", "Atypical symptoms", 
  "CPR history", "Chest pain relieved", 
  "Recent trauma/surgery", "Intracranial bleeding history"
)
## Create Table 1 stratified by trt
tableOne <- CreateTableOne(vars = c("T5Q0402"), data =bs, includeNA = F,addOverall=T)

# 将表格转换为数据框
tab1 <- as.data.frame(print(tableOne,showAllLevels = F, quote = FALSE, noSpaces = TRUE, missing = TRUE,contDigits = 1))

tab1 <- tab1 %>%
  separate(Overall, into = c("Frequency", "Percentage"), sep = "\\s\\(", fill = "right") %>%
  mutate(
    Percentage = gsub("\\)", "", Percentage),  # 去掉括号
    Frequency = as.numeric(Frequency),        # 转换为数值型
    Percentage = as.numeric(Percentage)       # 转换为数值型
  ) %>% slice(4:17) 
tab1$Category<-category_translation


# 绘制柱状图
p <- ggplot(tab1, aes(x = Percentage, y = reorder(Category, Frequency))) +
  geom_bar(stat = "identity", fill = "#4E79A7", width = 0.7) + # SCI期刊风格的蓝色填充
  geom_text(aes(label = Percentage),  # 在柱子上显示百分比
             hjust = -0.1,             # 标签在柱子右侧
            size = 4) +               # 调整标签大小
  theme_minimal(base_size = 14) +                             # 极简主题，适合发表
  theme(
  panel.grid.major.y = element_blank(),                      # 隐藏水平网格线
    panel.grid.major.x = element_line(color = "grey80"),       # 显示垂直网格线
    axis.title = element_text(size = 16, face = "bold", family = "sans"),  # 加粗并使用sans字体
    axis.text = element_text(size = 12, face = "bold", family = "sans"),   # 加粗并使用sans字体
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, family = "sans"), # 居中标题并使用sans字体
    legend.text = element_text(face = "bold", family = "sans"), # 图例文字加粗并使用sans字体
    legend.title = element_text(face = "bold", family = "sans") 
  ) +
  labs(
    title="",
    x = "Frequency",
    y=""
  ) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(tab1$Percentage) * 1.1)) # 
ggsave("/Users/yilin/Documents/文章/心肌梗死病例对照/数据分析/结果/图/Figure3.pdf",plot=p,width=30,height=20, units = "cm")
```